<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Xóc Đĩa - Play</title>
<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<style>
  /* Portrait lock style (UI optimized for vertical) */
  html,body{height:100%;margin:0;padding:0;background:#071025;font-family:Inter,Arial,Helvetica,sans-serif;color:#fff}
  .wrap{max-width:420px;margin:0 auto;padding:18px;display:flex;flex-direction:column;min-height:100vh;box-sizing:border-box}
  .card{background:linear-gradient(180deg,#0f2440 0%, #081226 100%);border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 8px 30px rgba(0,0,0,0.5)}
  h1,h2{margin:6px 0;font-weight:700}
  input,button,select{width:100%;box-sizing:border-box;padding:12px;border-radius:10px;border:none;font-size:16px}
  input{margin:8px 0;background:#0b1522;color:#fff}
  .btn{background:linear-gradient(90deg,#34d399,#10b981);color:#012018;cursor:pointer;font-weight:700}
  .btn.alt{background:linear-gradient(90deg,#f59e0b,#fb923c);color:#07203a}
  .center{display:flex;gap:8px}
  .center .half{flex:1}
  .small{font-size:13px;color:#a8c0d9;margin-top:6px}
  .balance{font-size:18px;font-weight:700;color:#facc15;margin:6px 0}
  canvas{display:block;background:#06263a;border-radius:12px;margin:12px auto;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
  .bets{display:flex;flex-direction:column;gap:8px}
  .bets button{padding:10px;background:linear-gradient(90deg,#2b6df0,#5b39f5);color:#fff;font-weight:700;border-radius:10px}
  .status{margin-top:8px;font-weight:700}
  footer{margin-top:auto;text-align:center;color:#8fa7c3;font-size:13px;padding:10px}

  /* small screens */
  @media (max-width:420px){
    .wrap{padding:12px}
    input,button{font-size:15px;padding:10px}
  }
</style>
</head>
<body>
<div class="wrap">
  <!-- AUTH CARD -->
  <div class="card" id="authCard">
    <h1>Xóc Đĩa</h1>
    <div id="registerForm">
      <h2>Đăng ký</h2>
      <input id="reg_user" placeholder="Tên đăng nhập (chỉ chữ & số)" />
      <input id="reg_pass" type="password" placeholder="Mật khẩu" />
      <button class="btn alt" onclick="handleRegister()">Đăng ký (Nhận 50,000)</button>
      <div class="small">Đã có tài khoản? <a href="#" style="color:#fff" onclick="showLogin()">Đăng nhập</a></div>
    </div>

    <div id="loginForm" style="display:none">
      <h2>Đăng nhập</h2>
      <input id="login_user" placeholder="Tên đăng nhập" />
      <input id="login_pass" type="password" placeholder="Mật khẩu" />
      <button class="btn" onclick="handleLogin()">Đăng nhập</button>
      <div class="small">Chưa có tài khoản? <a href="#" style="color:#fff" onclick="showRegister()">Đăng ký</a></div>
    </div>
  </div>

  <!-- GAME CARD -->
  <div class="card" id="gameCard" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-size:14px;color:#9fb6d3">Chào</div>
        <div id="uname" style="font-weight:800;font-size:18px"></div>
      </div>
      <div class="balance">Số dư: <span id="balance">0</span> VNĐ</div>
    </div>

    <canvas id="board" width="320" height="220"></canvas>

    <div style="margin-top:6px" class="small">Nhập tiền cược (VNĐ)</div>
    <input id="betInput" type="number" value="10000" min="100" />

    <div class="bets" style="margin-top:10px">
      <button onclick="startRound('chan')">Đặt Chẵn</button>
      <button onclick="startRound('le')">Đặt Lẻ</button>
      <div class="center">
        <div class="half"><button onclick="startRound('4trang')">4 Trắng</button></div>
        <div class="half"><button onclick="startRound('4do')">4 Đỏ</button></div>
      </div>
      <div class="center">
        <div class="half"><button onclick="startRound('3trang1do')">3 Trắng 1 Đỏ</button></div>
        <div class="half"><button onclick="startRound('3do1trang')">3 Đỏ 1 Trắng</button></div>
      </div>
    </div>

    <div class="status" id="status">Chờ lượt...</div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn alt" onclick="logout()">Đăng xuất</button>
      <button class="btn" onclick="refreshBalance()">Lấy số dư</button>
    </div>
  </div>

  <footer>Phiên bản demo — chạy với Firebase Realtime DB</footer>
</div>

<script>
/* ====== Firebase config (đã chèn) ====== */
const firebaseConfig = {
  apiKey: "AIzaSyDIUSmn1Y4wpESA1L4Pyf8IuCt-vcoewhU",
  authDomain: "duybaodz.firebaseapp.com",
  databaseURL: "https://duybaodz-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "duybaodz",
  storageBucket: "duybaodz.firebasestorage.app",
  messagingSenderId: "667991135203",
  appId: "1:667991135203:web:40e029b5acd7506c8bc6d6",
  measurementId: "G-JKFHFTBCYJ"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ====== App state ====== */
let currentUser = null;
let currentBalance = 0;

/* ====== UI helpers ====== */
function showLogin(){ document.getElementById('registerForm').style.display='none'; document.getElementById('loginForm').style.display='block'; }
function showRegister(){ document.getElementById('loginForm').style.display='none'; document.getElementById('registerForm').style.display='block'; }

function sanitizeName(name){
  return name.replace(/[^a-zA-Z0-9_-]/g,'').toLowerCase();
}

/* ====== Register / Login ====== */
async function handleRegister(){
  const user = sanitizeName(document.getElementById('reg_user').value.trim());
  const pass = document.getElementById('reg_pass').value.trim();
  if(!user || !pass){ alert('Nhập tên và mật khẩu hợp lệ'); return; }
  // check exists
  const ref = db.ref('users/' + user);
  const snap = await ref.get();
  if(snap.exists()){ alert('Tên đăng nhập đã tồn tại'); return; }
  // create with 50k
  await ref.set({ password: pass, balance: 50000, createdAt: new Date().toISOString() });
  alert('Đăng ký thành công! Vui lòng đăng nhập (50,000 đã được cộng).');
  // auto fill login fields and show login
  document.getElementById('login_user').value = user;
  document.getElementById('login_pass').value = pass;
  showLogin();
}

async function handleLogin(){
  const user = sanitizeName(document.getElementById('login_user').value.trim());
  const pass = document.getElementById('login_pass').value.trim();
  if(!user || !pass){ alert('Nhập tên và mật khẩu'); return; }
  const snap = await db.ref('users/' + user).get();
  if(!snap.exists()){ alert('Tài khoản không tồn tại'); return; }
  const data = snap.val();
  if(data.password !== pass){ alert('Sai mật khẩu'); return; }
  // success
  currentUser = user;
  currentBalance = data.balance || 0;
  document.getElementById('uname').innerText = user;
  document.getElementById('balance').innerText = currentBalance.toLocaleString();
  document.getElementById('authCard').style.display = 'none';
  document.getElementById('gameCard').style.display = 'block';
  // listen for balance updates
  db.ref('users/' + currentUser + '/balance').on('value', s=>{
    const v = s.val() || 0;
    currentBalance = v;
    document.getElementById('balance').innerText = v.toLocaleString();
    // flash status when updated externally
    flashStatus('Số dư được cập nhật: ' + v.toLocaleString());
  });
}

/* ====== Game logic & animation ====== */
const canvas = document.getElementById('board');
const ctx = canvas.getContext('2d');

function drawBoard(redsCount = 0, animPositions = null){
  // clear
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // background circle
  ctx.fillStyle = '#062a3d';
  ctx.beginPath(); ctx.roundRect = ctx.roundRect || function(x,y,w,h,r){ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);};
  ctx.fillRect(0,0,canvas.width,canvas.height);
  // place 4 coins in diamond
  const cx = canvas.width/2, cy = canvas.height/2;
  const positions = [
    {x:cx-70,y:cy-30},
    {x:cx+70,y:cy-30},
    {x:cx-40,y:cy+60},
    {x:cx+40,y:cy+60}
  ];
  for(let i=0;i<4;i++){
    const pos = animPositions ? animPositions[i] : positions[i];
    const isRed = i < redsCount ? true : false; // note: we'll not strictly bind; we'll accept draw with count
    // coin
    ctx.beginPath();
    ctx.fillStyle = (i < redsCount) ? '#e74c3c' : '#ffffff';
    ctx.arc(pos.x,pos.y,28,0,Math.PI*2);
    ctx.fill();
    // stroke
    ctx.lineWidth = 2; ctx.strokeStyle = '#0b1b25'; ctx.stroke();
    // inner dot
    ctx.beginPath();
    ctx.fillStyle = (i < redsCount) ? '#8b1f1f' : '#d0d7df';
    ctx.arc(pos.x,pos.y,8,0,Math.PI*2);
    ctx.fill();
  }
}

// animate shaking — returns final whitesCount (we'll compute from reds)
function animateShakeWeighted(){
  return new Promise(resolve=>{
    const start = performance.now();
    const duration = 1100;
    // We'll pick final whitesCount with weighted distribution favoring even (chẵn).
    // We want chẵn more likely: weights: 0(4red):8,1:2,2:12,3:2,4:8  -> chẵn total 20 / 32 ~62%
    const weighted = [0,0,0,0,0,0,0,0, 1,1, 2,2,2,2,2,2,2,2,2,2,2,2, 3,3, 4,4,4,4,4,4,4,4];
    const finalWhites = weighted[Math.floor(Math.random()*weighted.length)]; // 0..4 whites
    // For animation positions, do jitter then settle
    function frame(t){
      const p = Math.min(1,(t-start)/duration);
      // jitter positions
      const base = [
        {x:canvas.width/2-70,y:canvas.height/2-30},
        {x:canvas.width/2+70,y:canvas.height/2-30},
        {x:canvas.width/2-40,y:canvas.height/2+60},
        {x:canvas.width/2+40,y:canvas.height/2+60}
      ];
      const animPositions = base.map(pos=>{
        const amp = (1-p)*16;
        return {x: pos.x + (Math.random()*2-1)*amp, y: pos.y + (Math.random()*2-1)*amp};
      });
      // draw using finalWhites as number of white coins; but to show randomness we'll render random red/white until settle
      const interimCount = (p<0.9) ? Math.floor(Math.random()*5) : finalWhites;
      // The drawBoard expects redsCount - we'll convert: redsCount = 4 - whitesCount
      const redsCount = 4 - interimCount;
      drawBoard(redsCount, animPositions);
      if(p < 1) requestAnimationFrame(frame);
      else resolve(finalWhites);
    }
    requestAnimationFrame(frame);
  });
}

function flashStatus(msg){
  const s = document.getElementById('status');
  s.innerText = msg;
  s.style.opacity = 1;
  setTimeout(()=>{ s.style.opacity = 0.9; }, 100);
}

/* start round when user clicks */
async function startRound(choice){
  if(!currentUser){ alert('Vui lòng đăng nhập'); return; }
  const bet = parseInt(document.getElementById('betInput').value) || 0;
  if(bet <= 0){ alert('Nhập số tiền cược hợp lệ'); return; }
  // read current balance once
  const snap = await db.ref('users/' + currentUser).get();
  let bal = (snap.exists() && snap.val().balance) ? snap.val().balance : 0;
  if(bet > bal){ alert('Không đủ tiền'); return; }
  // deduct immediately (optimistic)
  await db.ref('users/' + currentUser + '/balance').set(bal - bet);
  document.getElementById('status').innerText = 'Đang lắc...';
  // animate
  const whites = await animateShakeWeighted(); // 0..4 whites
  // determine results
  const reds = 4 - whites;
  const parity = (whites % 2 === 0) ? 'chan' : 'le';
  let win = false;
  let multiplier = 1; // multiplier of bet returned as winAmount = bet * multiplier
  // special cases: whites ===4 -> 4 trắng ; whites===0 -> 4 đỏ ; whites===3 -> 3trang1do ; whites===1 -> 3do1trang
  if(choice === 'chan' && parity === 'chan') {
    win = true; multiplier = 2;
  }
  if(choice === 'le' && parity === 'le') {
    win = true; multiplier = 2;
  }
  if(choice === '4trang' && whites === 4) { win = true; multiplier = 2; }
  if(choice === '4do' && whites === 0) { win = true; multiplier = 2; }
  if(choice === '3trang1do' && whites === 3) { win = true; multiplier = 2; }
  if(choice === '3do1trang' && whites === 1) { win = true; multiplier = 2; }

  // compute win/lose and update DB
  if(win){
    const winAmount = bet * multiplier;
    // add winAmount to balance
    const newBal = (bal - bet) + winAmount;
    await db.ref('users/' + currentUser + '/balance').set(newBal);
    // log if special
    const special = (whites===4 || whites===0 || whites===3 || whites===1);
    const msg = special ? `Kết quả: ${whites} trắng (${reds} đỏ) — Thắng! X2 tiền (+${winAmount} VNĐ)` : `Kết quả: ${whites} trắng (${reds} đỏ) — Thắng! (+${winAmount} VNĐ)`;
    document.getElementById('status').innerText = msg;
    // optional push small result log
    db.ref('logs').push({ user: currentUser, type: 'win', detail: `${whites} trắng`, amount: winAmount, time: new Date().toISOString() });
  } else {
    const newBal = (bal - bet);
    await db.ref('users/' + currentUser + '/balance').set(newBal);
    document.getElementById('status').innerText = `Kết quả: ${whites} trắng (${reds} đỏ) — Thua (-${bet} VNĐ)`;
    db.ref('logs').push({ user: currentUser, type: 'lose', detail: `${whites} trắng`, amount: bet, time: new Date().toISOString() });
  }
}

/* refresh balance manual */
async function refreshBalance(){
  if(!currentUser) return;
  const snap = await db.ref('users/' + currentUser + '/balance').get();
  if(snap.exists()) document.getElementById('balance').innerText = (snap.val() || 0).toLocaleString();
}

/* logout */
function logout(){
  if(currentUser){
    db.ref('users/' + currentUser + '/balance').off();
  }
  currentUser = null;
  document.getElementById('authCard').style.display = 'block';
  document.getElementById('gameCard').style.display = 'none';
  document.getElementById('status').innerText = 'Chờ lượt...';
  // reset canvas
  drawBoard(0);
}

/* initialize draw */
drawBoard(0);
</script>
</body>
</html>